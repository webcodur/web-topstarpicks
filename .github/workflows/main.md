# TopStarPicks CI/CD 파이프라인 (블루-그린 배포) 해설 가이드

이 가이드는 TopStarPicks 프로젝트의 CI/CD 파이프라인을 설명합니다. 이 파이프라인은 GitHub Actions를 사용하여 블루-그린 배포 전략을 구현합니다.

## 개요

1. 이 워크플로우는 `main` 브랜치에 push가 발생하거나 수동으로 트리거될 때 실행됩니다.
2. 블루-그린 배포 전략을 사용하여 무중단 배포를 구현합니다.
3. React 프론트엔드와 Node.js 백엔드를 모두 관리합니다.

## 환경 변수

- `HOME`: 루트 디렉토리 (/root)
- `BLUE_PORT`: 블루 버전이 사용하는 포트 (3002)
- `GREEN_PORT`: 그린 버전이 사용하는 포트 (3003)

## 주요 단계

### 0. 초기 설정

1. 코드 체크아웃
2. 현재 활성 빌드(블루 또는 그린) 확인

### 1. 새 빌드 결정

- 현재 활성 빌드의 반대 색상을 새 빌드로 선택
- 새 빌드와 이전 빌드의 포트 번호 설정

### React 프론트엔드 배포 (R1-R5)

1. **R1. React 빌드 준비 및 빌드**
   - 최신 코드 풀
   - 새 빌드 디렉토리 생성
   - yarn을 사용하여 의존성 설치 및 빌드
   - 빌드 결과물을 새 디렉토리로 이동

2. **R2. 새 React 버전 시작**
   - tmux를 사용하여 새 버전의 React 앱을 백그라운드에서 실행

3. **R3. Nginx 설정 업데이트**
   - Nginx 설정 파일에서 새 버전의 포트로 프록시 설정 변경
   - 이전 버전을 백업 서버로 설정
   - Nginx 설정 테스트 후 재로드

4. **R4. 활성 빌드 업데이트**
   - 새 빌드 정보를 파일에 기록

5. **R5. 이전 React 버전 중지**
   - tmux 세션을 종료하여 이전 버전의 React 앱 중지

### Node.js 백엔드 배포 (B1)

1. **B1. Node.js 백엔드 재시작**
   - 기존 백엔드 tmux 세션 종료 (존재하는 경우)
   - 새로운 tmux 세션에서 백엔드 재시작
   - 최신 의존성 설치 및 프로덕션 모드로 서버 실행

## 주의사항

1. 이 파이프라인은 self-hosted 러너에서 실행되므로, 러너 환경이 적절히 설정되어 있어야 합니다.
2. GitHub 토큰을 사용하여 private 저장소에 접근하므로, 보안에 유의해야 합니다.
3. Nginx 설정 변경 시 sudo 권한이 필요하므로, 러너에 적절한 권한이 부여되어 있어야 합니다.

## 결론

이 CI/CD 파이프라인은 블루-그린 배포 전략을 통해 무중단 배포를 구현하며, 프론트엔드와 백엔드 모두를 관리합니다. 각 단계는 체계적으로 구성되어 있어 안정적인 배포 프로세스를 보장합니다.